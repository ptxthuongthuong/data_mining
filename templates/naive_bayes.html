{% extends "base_algorithm.html" %}
{% block algorithm_content %}
{% from "components.html" import select_columns, input_values %}

{% if dataset_info %}
    <!-- Form section -->
    <div class="form-section">
         <form id="naive-bayes-form" action="/run_naive_bayes" method="post">
             <!-- Các trường form giữ nguyên -->
             <label for="target_column">Chọn cột mục tiêu (target):</label>
             <select name="target_column" id="target_column">
                 {% for column in dataset_info['columns'] %}
                     <option value="{{ column }}">{{ column }}</option>
                 {% endfor %}
             </select>
             <br>
     
             {{ select_columns(dataset_info['columns'], "selected_columns") }}
             <br>
             {{ input_values(dataset_info['columns'], dataset_info['unique_values']) }}
             <br>
             <label for="use_laplace">Sử dụng Laplace smoothing?</label>
             <input type="checkbox" id="use_laplace" name="use_laplace" value="true">
             <br>
             <button type="submit">Chạy Naive Bayes</button>
         </form>
    </div>

    <!-- Result section - LUÔN để riêng biệt với form -->
    <div id="result-container">
        {% if result %}
            <h3>Kết quả phân lớp:</h3>
            <p>{{ result }}</p>
        {% endif %}
    </div>

    <script>
        // Script cho checkbox columns
        const checkboxes = document.querySelectorAll('input[name="selected_columns"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const columnId = 'values_' + this.value;
                const columnDiv = document.getElementById(columnId);
                if (this.checked) {
                    columnDiv.style.display = 'block';
                } else {
                    columnDiv.style.display = 'none';
                }
            });
        });

        // Script cho AJAX submission
        document.getElementById('naive-bayes-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            var formData = new FormData(this);
            
            // Hiển thị trạng thái loading
            document.getElementById('result-container').innerHTML = '<p>Đang xử lý...</p>';
            
            fetch('/run_naive_bayes', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'  // Thêm header này
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                // CHỈ cập nhật phần result-container
                document.getElementById('result-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result-container').innerHTML = 
                    '<p style="color: red;">Có lỗi xảy ra khi xử lý yêu cầu</p>';
            });
        });
    </script>
{% else %}
    <p>Vui lòng tải lên file dữ liệu trước khi sử dụng thuật toán này.</p>
{% endif %}
{% endblock %}